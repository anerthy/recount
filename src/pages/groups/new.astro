---
import { getCategories } from '@/actions/categories/get-categories.action';
import { getUsers } from '@/actions/users/get-users.action';
import AdminLayout from '@/layouts/AdminLayout.astro';
import { supabase } from '@/lib/supabase';

const accessToken = Astro.cookies.get('sb-access-token');
const refreshToken = Astro.cookies.get('sb-refresh-token');

const session = await supabase.auth.setSession({
  refresh_token: refreshToken!.value,
  access_token: accessToken!.value,
});

const userId = session.data.user?.id!;

const { error: usersError, data } = await Astro.callAction(getUsers, {});
const users = data?.filter((user) => user.id !== userId) ?? [];

const { data: categories, error: categoriesError } = await Astro.callAction(
  getCategories,
  {}
);
---

<AdminLayout
  title="New Group"
  description="Create a new group"
  backLink="/groups"
>
  <div class="flex-1 px-4">
    <form>
      <input type="hidden" name="user-id" value={userId} />
      <div class="flex w-full flex-col items-center gap-4 py-6">
        <div class="relative">
          <div
            class="bg-center bg-no-repeat aspect-square bg-cover rounded-full h-28 w-28 bg-gray-200"
            data-alt="Default group avatar placeholder"
            style='background-image: url("https://lh3.googleusercontent.com/aida-public/AB6AXuDhl1gkT7H1LHVrBXT367ng9eMltP-SwOMNWIsq3x-mwEOn31fShCkKDX7ypALyU-WcoyK_XlnPEYklC-pPqEUbA_p6lowKY0GbHMf1i1kab2U1epyHB8nYjpIDv7LTUfqOgR-i-NiDP9dU518mmfOmTeoU_aX-HU-8SKeuGKDPZpN0aND9i6sbbtefMlKYeMPbh7iamg2GB4MBeTGgiNpbbpW2jtyPKpeuHQm07nLvOk5de5qcmKogQKkbnKZKpYFqgpgZjBgFww");'
          >
          </div>
          <button
            class="absolute bottom-0 right-0 flex h-9 w-9 items-center justify-center rounded-full border-2 border-background-light bg-primary text-[#10221f]"
          >
            <span class="material-symbols-outlined text-xl">add_a_photo</span>
          </button>
        </div>
      </div>
      <div class="flex w-full max-w-md mx-auto flex-col gap-4">
        <label class="flex flex-col w-full" for="group-name">
          <p class="text-sm font-medium leading-normal pb-2">Group Name</p>
          <input
            id="group-name"
            name="group-name"
            type="text"
            required
            class="form-input flex w-full min-w-0 flex-1 overflow-hidden rounded-xl text-[#111817] focus:outline-0 focus:ring-2 focus:ring-primary/50 border border-gray-300 bg-white h-28 placeholder:text-gray-400 px-4 text-base font-normal leading-normal"
            placeholder="E.g: Main Street Apartment"
            value=""
          />
        </label>

        <label class="flex flex-col w-full">
          <p class="text-sm font-medium leading-normal pb-2">
            Description (optional)
          </p>
          <textarea
            id="group-description"
            name="group-description"
            class="form-input flex w-full min-w-0 flex-1 resize-none overflow-hidden rounded-xl text-[#111817] focus:outline-0 focus:ring-2 focus:ring-primary/50 border border-gray-300 bg-white min-h-6 placeholder:text-gray-400 p-4 text-base font-normal leading-normal"
            placeholder="Add a description for your group"></textarea>
        </label>

        <label class="flex flex-col w-full" for="category">
          <p class="text-sm font-medium leading-normal pb-2">Category</p>
          <select
            id="category"
            name="category"
            class="border border-gray-300 rounded-xl p-3 text-gray-700"
          >
            {
              categories?.map(({ id, name }) => (
                <option
                  value={id}
                  class="border border-gray-300 rounded-xl p-2 text-gray-700 m-2"
                >
                  {name}
                </option>
              ))
            }
          </select>
        </label>

        <label class="flex flex-col w-full" for="members">
          <p class="text-sm font-medium leading-normal pb-2">Members</p>
          <select
            id="members"
            multiple
            class="border border-gray-300 rounded-xl p-3 text-gray-700"
          >
            {
              users.map(({ id, username, email }) => (
                <option
                  value={id}
                  class="border border-gray-300 rounded-xl p-2 text-gray-700 m-2"
                >
                  {username} - {email}
                </option>
              ))
            }
          </select>
        </label>
      </div>
      <footer class="p-4 bg-linear-to-t from-background-light to-transparent">
        <div class="max-w-md mx-auto">
          <button
            type="submit"
            class="flex w-full min-w-[84px] cursor-pointer items-center justify-center overflow-hidden rounded-xl h-14 px-4 bg-primary text-[#10221f] text-base font-bold leading-normal tracking-[0.015em] shadow-lg shadow-primary/30"
          >
            <span class="truncate">Create Group</span>
          </button>
        </div>
      </footer>
    </form>
    <!-- Members -->
    <!-- <div class="w-full max-w-md mx-auto pt-8">
            <h3
              class="text-[#111817] text-lg font-bold leading-tight tracking-[-0.015em] pb-3"
            >
              Group Members
            </h3>
            <div
              class="text-center rounded-xl border-2 border-dashed border-gray-300 p-6"
            >
              <div
                class="flex justify-center items-center mx-auto h-12 w-12 rounded-full bg-primary/20 text-primary"
              >
                <span class="material-symbols-outlined text-3xl">group_add</span
                >
              </div>
              <p class="mt-4 text-sm font-semibold text-gray-800">
                Add members to your group
              </p>
              <p class="mt-1 text-sm text-gray-500">
                Add friends to start sharing expenses.
              </p>
            </div>
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-3 mt-4">
              <button
                class="flex w-full cursor-pointer items-center justify-center gap-2 overflow-hidden rounded-xl h-12 px-4 bg-gray-200 text-gray-800 text-sm font-bold leading-normal tracking-[0.015em]"
              >
                <span class="material-symbols-outlined text-xl"
                  >contact_phone</span
                >
                <span class="truncate">From Contacts</span>
              </button>
              <button
                class="flex w-full cursor-pointer items-center justify-center gap-2 overflow-hidden rounded-xl h-12 px-4 bg-gray-200 text-gray-800 text-sm font-bold leading-normal tracking-[0.015em]"
              >
                <span class="material-symbols-outlined text-xl">add</span>
                <span class="truncate">Manually</span>
              </button>
            </div>
          </div> -->
    <!-- Members -->
    <div class="w-full max-w-md mx-auto pt-8 pb-32">
      <h3
        class="text-[#111817] text-lg font-bold leading-tight tracking-[-0.015em] pb-3"
      >
        Group Settings
      </h3>
      <div class="flex flex-col w-full gap-4">
        <div class="flex flex-col w-full">
          <label
            class="text-sm font-medium leading-normal pb-2"
            for="currency-select">Currency</label
          >
          <button
            class="flex w-full items-center justify-between rounded-xl border border-gray-300 bg-white px-4 py-3 text-left"
          >
            <div class="flex items-center gap-3">
              <div
                class="flex h-8 w-8 items-center justify-center rounded-full bg-gray-200 text-base font-bold text-gray-600"
              >
                â‚¬
              </div>
              <div>
                <p class="font-semibold text-[#111817]">CRC</p>
                <p class="text-xs text-gray-500">Colones</p>
              </div>
            </div>
            <span class="material-symbols-outlined text-gray-400"
              >expand_more</span
            >
          </button>
        </div>
        <div class="flex flex-col w-full">
          <label
            class="text-sm font-medium leading-normal pb-2"
            for="split-rule-select">Default Expense Division</label
          >
          <button
            class="flex w-full items-center justify-between rounded-xl border border-gray-300 bg-white px-4 py-3 text-left"
          >
            <div class="flex items-center gap-3">
              <div
                class="flex h-8 w-8 items-center justify-center rounded-full bg-primary/20 text-primary"
              >
                <span class="material-symbols-outlined text-xl"
                  >splitscreen</span
                >
              </div>
              <div>
                <p class="font-semibold text-[#111817]">Dividir por igual</p>
                <p class="text-xs text-gray-500">
                  El coste se divide equitativamente
                </p>
              </div>
            </div>
            <span class="material-symbols-outlined text-gray-400"
              >expand_more</span
            >
          </button>
        </div>
      </div>
    </div>
  </div>
</AdminLayout>
<script>
  import { actions } from 'astro:actions';
  import { navigate } from 'astro:transitions/client';

  const form = document.querySelector('form') as HTMLFormElement;

  form.addEventListener('submit', async (event) => {
    event.preventDefault();

    const formData = new FormData(form);
    const userId = formData.get('user-id') as string;
    const name = formData.get('group-name') as string;
    const category = formData.get('category') as string;
    const description = formData.get('group-description') as string;
    const membersSelect = document.getElementById(
      'members'
    ) as HTMLSelectElement;
    const members = Array.from(membersSelect.selectedOptions).map(
      (option) => option.value
    );

    const group = {
      userId,
      members,
      name,
      description,
      category,
    };
    console.log(group);

    const { error } = await actions.createGroup(group);

    if (error) {
      alert('Error creating group: ' + error.message);
      return;
    }

    navigate('/groups');
  });
</script>
