---
import { getUserGroups } from '@/actions/groups/get-user-groups.action';
import UserIcon from '../icons/UserIcon.astro';
import GroupItem from './GroupItem.astro';
import { supabase } from '@/lib/supabase';

const accessToken = Astro.cookies.get('sb-access-token');
const refreshToken = Astro.cookies.get('sb-refresh-token');

const session = await supabase.auth.setSession({
  refresh_token: refreshToken!.value,
  access_token: accessToken!.value,
});

const userId = session.data.user?.id!;

const { data, error } = await Astro.callAction(getUserGroups, {
  userId,
});

if (error) {
  return Astro.redirect('/404');
}
---

<div class="lg:col-span-2 bg-white rounded-xl shadow-sm border border-gray-200">
  <div class="p-6 border-b border-gray-200">
    <h2 class="text-lg font-semibold text-gray-900">
      <a href="/groups">Your groups</a>
    </h2>
  </div>
  <div class="p-6">
    <div class="space-y-4">
      {
        data?.map(({ group_id: id, name, description, joined_at }) => (
          <GroupItem
            id={id}
            name={name}
            description={description}
            timestamp={new Date(joined_at).toLocaleDateString()}
          >
            <UserIcon slot="icon" />
          </GroupItem>
        ))
      }
    </div>
  </div>
</div>
